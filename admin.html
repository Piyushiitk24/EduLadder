<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduLadder Admin - Question Manager</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/x-icon" href="images/icon.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .admin-screen {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            font-family: 'Arial', sans-serif;
        }

        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .admin-header {
            background: linear-gradient(135deg, #8da7ee, #5577ff);
            color: white;
            text-align: center;
            padding: 40px 20px;
        }

        .admin-header h1 {
            font-size: 2.5rem;
            margin: 0 0 10px 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .admin-header p {
            font-size: 1.2rem;
            margin: 10px 0;
            opacity: 0.9;
        }

        .instruction-banner {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            padding: 20px;
            margin: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .main-content {
            padding: 40px;
        }

        .upload-section {
            background: linear-gradient(145deg, #f8f9ff, #e8f0ff);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            border: 3px dashed #2455db;
            text-align: center;
        }

        .upload-section h2 {
            color: #2455db;
            margin-bottom: 20px;
            font-size: 1.8rem;
        }

        .file-upload-area {
            background: white;
            border: 2px dashed #ccc;
            border-radius: 15px;
            padding: 40px;
            margin: 20px 0;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-upload-area:hover {
            border-color: #2455db;
            background: #f0f8ff;
        }

        .file-upload-area.dragover {
            border-color: #2455db;
            background: #e8f4fd;
        }

        .upload-icon {
            font-size: 3rem;
            color: #2455db;
            margin-bottom: 20px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #2455db, #4169e1);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
            box-shadow: 0 4px 15px rgba(36, 85, 219, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(36, 85, 219, 0.4);
        }

        .btn-success {
            background: linear-gradient(45deg, #28a745, #20c997);
        }

        .btn-success:hover {
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }

        .modules-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .module-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .module-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.15);
            border-color: #2455db;
        }

        .module-card.selected {
            border-color: #2455db;
            background: linear-gradient(145deg, #f0f8ff, #e8f4fd);
        }

        .module-icon {
            width: 60px;
            height: 60px;
            margin: 0 auto 15px;
            background: linear-gradient(45deg, #2455db, #4169e1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }

        .module-card h3 {
            color: #2455db;
            margin: 15px 0 10px;
            font-size: 1.3rem;
        }

        .module-card p {
            color: #666;
            font-size: 0.95rem;
            margin-bottom: 15px;
        }

        .question-count {
            background: #e8f4fd;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            color: #2455db;
            margin: 10px 0;
        }

        .status-message {
            padding: 15px 20px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 500;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .hidden {
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #2455db, #4169e1);
            width: 0%;
            transition: width 0.3s ease;
        }

        .navigation {
            text-align: center;
            padding: 30px;
            background: #f8f9fa;
        }

        .back-to-game {
            background: linear-gradient(45deg, #6c757d, #495057);
            color: white;
            text-decoration: none;
            padding: 12px 25px;
            border-radius: 25px;
            display: inline-block;
            transition: all 0.3s ease;
        }

        .back-to-game:hover {
            transform: translateY(-2px);
            color: white;
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
        }

        @media (max-width: 768px) {
            .modules-grid {
                grid-template-columns: 1fr;
            }
            
            .admin-header h1 {
                font-size: 2rem;
            }
            
            .main-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="admin-screen">
        <div class="admin-container">
            <div class="admin-header">
                <h1><i class="fas fa-graduation-cap"></i> EduLadder Admin Panel</h1>
                <p>Question Management System for Teachers</p>
            </div>

            <div class="instruction-banner">
                <h3><i class="fas fa-info-circle"></i> Step-by-Step Instructions</h3>
                <p><strong>1.</strong> Download CSV template below <strong>2.</strong> Edit with your questions <strong>3.</strong> Upload CSV file <strong>4.</strong> Questions are merged into game</p>
                <p><strong>📋 Important:</strong> CSV uploads ADD questions to existing ones • Use exact format from template • Questions appear immediately in game</p>
            </div>

            <div class="main-content">
                <!-- CSV Upload Section -->
                <div class="upload-section">
                    <h2><i class="fas fa-cloud-upload-alt"></i> Upload Question Bank</h2>
                    
                    <div class="file-upload-area" onclick="document.getElementById('csvFile').click()">
                        <div class="upload-icon">
                            <i class="fas fa-file-csv"></i>
                        </div>
                        <h3>Click to Select CSV File</h3>
                        <p>Or drag and drop your CSV file here</p>
                        <small>Supported format: .csv files only</small>
                        <input type="file" id="csvFile" accept=".csv" style="display: none;" onchange="handleFileSelect(event)">
                    </div>

                    <div id="fileInfo" class="hidden">
                        <p><strong>Selected File:</strong> <span id="fileName"></span></p>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                    </div>

                    <div style="margin: 20px 0;">
                        <button class="btn-primary" onclick="uploadCSV()">
                            <i class="fas fa-upload"></i> Upload & Merge Questions
                        </button>
                        <button class="btn-success" onclick="downloadTemplate()">
                            <i class="fas fa-download"></i> Download CSV Template
                        </button>
                    </div>
                </div>

                <!-- Module Cards Section -->
                <div>
                    <h2 style="text-align: center; color: #2455db; margin-bottom: 30px;">
                        <i class="fas fa-books"></i> Learning Modules Overview
                    </h2>
                    <div class="modules-grid">
                        <div class="module-card" data-module="mod1">
                            <div class="module-icon"><i class="fas fa-cube"></i></div>
                            <h3>Module 1</h3>
                            <p>Domains of Learning</p>
                            <div class="question-count" id="count-mod1">Loading...</div>
                        </div>

                        <div class="module-card" data-module="mod2">
                            <div class="module-icon"><i class="fas fa-list-alt"></i></div>
                            <h3>Module 2</h3>
                            <p>TOS, Master Syllabus & Evaluation</p>
                            <div class="question-count" id="count-mod2">Loading...</div>
                        </div>

                        <div class="module-card" data-module="mod3">
                            <div class="module-icon"><i class="fas fa-chalkboard-teacher"></i></div>
                            <h3>Module 3</h3>
                            <p>TL process, Andragogy, SAT, BTM & Ways of Learning</p>
                            <div class="question-count" id="count-mod3">Loading...</div>
                        </div>

                        <div class="module-card" data-module="mod4">
                            <div class="module-icon"><i class="fas fa-bullseye"></i></div>
                            <h3>Module 4</h3>
                            <p>Objectives, Maxims & Questioning Technique</p>
                            <div class="question-count" id="count-mod4">Loading...</div>
                        </div>

                        <div class="module-card" data-module="mod5">
                            <div class="module-icon"><i class="fas fa-users"></i></div>
                            <h3>Module 5</h3>
                            <p>Lesson, Lecture, Demonstration, Group Discussion, Coaching, CBT, Media in Training</p>
                            <div class="question-count" id="count-mod5">Loading...</div>
                        </div>

                        <div class="module-card" data-module="mod6">
                            <div class="module-icon"><i class="fas fa-user-tie"></i></div>
                            <h3>Module 6</h3>
                            <p>Instructor Like Qualities, Video in Training, Feedback</p>
                            <div class="question-count" id="count-mod6">Loading...</div>
                        </div>

                        <div class="module-card" data-module="mod7">
                            <div class="module-icon"><i class="fas fa-chart-bar"></i></div>
                            <h3>Module 7</h3>
                            <p>TDEC, Item Analysis, Result Analysis</p>
                            <div class="question-count" id="count-mod7">Loading...</div>
                        </div>

                        <div class="module-card" data-module="mod8">
                            <div class="module-icon"><i class="fas fa-book"></i></div>
                            <h3>Module 8</h3>
                            <p>Training Directives</p>
                            <div class="question-count" id="count-mod8">Loading...</div>
                        </div>

                        <div class="module-card" data-module="mod9">
                            <div class="module-icon"><i class="fas fa-comments"></i></div>
                            <h3>Module 9</h3>
                            <p>Motivation, Communication, Code of Ethics</p>
                            <div class="question-count" id="count-mod9">Loading...</div>
                        </div>
                    </div>
                </div>

                <!-- Status Messages -->
                <div id="statusContainer"></div>
            </div>

            <div class="navigation">
                <a href="index.html" class="back-to-game">
                    <i class="fas fa-gamepad"></i> Back to Game
                </a>
                <a href="teacher-resources/TEACHER_GUIDE.md" class="back-to-game" style="background: linear-gradient(45deg, #28a745, #20c997); margin-left: 10px;" target="_blank">
                    <i class="fas fa-book"></i> Teacher Guide
                </a>
            </div>
        </div>
    </div>

    <script>
        let selectedModule = null;
        let allQuestionsData = {};

        // Load questions data on page load
        window.addEventListener('load', async function() {
            await loadQuestionsData();
            updateQuestionCounts();
        });

        // File upload handling
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('fileInfo').classList.remove('hidden');
                
                // Simulate progress for visual feedback
                const progressFill = document.getElementById('progressFill');
                progressFill.style.width = '100%';
            }
        }

        // Drag and drop functionality
        const uploadArea = document.querySelector('.file-upload-area');
        
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            this.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type === 'text/csv') {
                document.getElementById('csvFile').files = files;
                handleFileSelect({ target: { files: files } });
            } else {
                showStatus('Please drop a valid CSV file.', 'error');
            }
        });

        // Load questions data from JSON file
        async function loadQuestionsData() {
            try {
                const response = await fetch('./questions/questions.json');
                allQuestionsData = await response.json();
                console.log('Questions data loaded:', allQuestionsData);
            } catch (error) {
                console.error('Error loading questions:', error);
                showStatus('Could not load existing questions data.', 'error');
            }
        }

        // Update question counts for each module
        function updateQuestionCounts() {
            const modules = ['mod1', 'mod2', 'mod3', 'mod4', 'mod5', 'mod6', 'mod7', 'mod8', 'mod9'];
            
            console.log('Updating question counts. Data loaded:', !!allQuestionsData);
            if (allQuestionsData) {
                console.log('Questions data keys:', Object.keys(allQuestionsData));
            }
            
            modules.forEach(moduleId => {
                const countElement = document.getElementById(`count-${moduleId}`);
                if (allQuestionsData && allQuestionsData[moduleId] && Array.isArray(allQuestionsData[moduleId])) {
                    // Count questions by difficulty from the array
                    const easyCount = allQuestionsData[moduleId].filter(q => q.difficulty === 'easy').length;
                    const hardCount = allQuestionsData[moduleId].filter(q => q.difficulty === 'hard').length;
                    console.log(`${moduleId}: ${easyCount} easy, ${hardCount} hard (total: ${allQuestionsData[moduleId].length})`);
                    countElement.textContent = `${easyCount} Easy • ${hardCount} Hard`;
                    countElement.style.background = easyCount > 0 || hardCount > 0 ? '#d4edda' : '#f8d7da';
                    countElement.style.color = easyCount > 0 || hardCount > 0 ? '#155724' : '#721c24';
                } else {
                    console.log(`${moduleId}: No data found or invalid format`);
                    countElement.textContent = '0 Easy • 0 Hard';
                    countElement.style.background = '#f8d7da';
                    countElement.style.color = '#721c24';
                }
            });
        }

        function downloadTemplate() {
            // Create the exact template content matching our requirements
            const csvContent = `module_id,module_name,difficulty,question_text,option_a,option_b,option_c,option_d,correct_option
tlprocess,Teaching Learning Process,easy,What is the first step in the teaching-learning process?,Assessment,Planning,Implementation,Evaluation,B
tlprocess,Teaching Learning Process,hard,According to Kolb's experiential learning theory which stage follows 'Concrete Experience'?,Abstract Conceptualization,Reflective Observation,Active Experimentation,Theoretical Analysis,B
learningtheories,Learning Theories,easy,Who is known as the father of behaviorism?,Jean Piaget,B.F. Skinner,John Watson,Albert Bandura,C
learningtheories,Learning Theories,hard,According to Vygotsky's Zone of Proximal Development learning occurs best when:,Students work completely independently,Tasks are too difficult to complete,Students receive appropriate guidance,Learning is purely theoretical,C
fourways,4 Ways of Learning,easy,Visual learners prefer to learn through:,Listening to lectures,Seeing charts and diagrams,Physical movement,Group discussions,B
fourways,4 Ways of Learning,hard,According to Fleming's VARK model multimodal learners:,Use only one learning style,Combine multiple learning preferences,Avoid visual inputs,Focus solely on auditory learning,B
andragogy,Andragogy,easy,Andragogy is the study of:,Child learning,Adult learning,Animal behavior,Memory techniques,B
andragogy,Andragogy,hard,Knowles' andragogical model assumes that adults:,Have no prior experience,Are externally motivated only,Have a problem-centered orientation,Learn exactly like children,C
sat,Systematic Approach to Training (SAT),easy,SAT stands for:,Simple Approach to Teaching,Systematic Approach to Training,Strategic Academic Training,Standard Assessment Tool,B
sat,Systematic Approach to Training (SAT),hard,In the SAT model which phase involves determining the gap between current and desired performance?,Design phase,Analysis phase,Implementation phase,Evaluation phase,B
btm,Basic Teaching Model,easy,The Basic Teaching Model typically includes:,Only assessment,Preparation presentation practice,Just lecturing,Testing only,B
btm,Basic Teaching Model,hard,The Basic Teaching Model's effectiveness depends heavily on:,Student compliance only,Proper sequencing and alignment of components,Teacher personality,Classroom size,B
dol,Domains of Learning,easy,The three main domains of learning are:,Reading writing arithmetic,Cognitive affective psychomotor,Visual auditory kinesthetic,Memory thinking feeling,B
dol,Domains of Learning,hard,In Bloom's revised cognitive taxonomy which level represents the highest form of cognitive processing?,Analyzing,Evaluating,Creating,Applying,C
objectives,Writing Objectives,easy,A learning objective should be:,Vague and general,Specific and measurable,Impossible to achieve,Only for teachers,B
objectives,Writing Objectives,hard,According to Mager's criteria for writing objectives which component specifies the acceptable level of performance?,Condition,Behavior,Criterion,Context,C`;
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'template_questions.csv';
            a.click();
            window.URL.revokeObjectURL(url);
            
            showStatus('✅ CSV template downloaded successfully! Edit this file with your questions and upload it back.', 'success');
        }

        function uploadCSV() {
            const fileInput = document.getElementById('csvFile');

            if (!fileInput.files[0]) {
                showStatus('❌ Please select a CSV file first!', 'error');
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();

            showStatus('📤 Processing your CSV file...', 'info');

            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    console.log('CSV content loaded:', csv.substring(0, 200));
                    
                    const questions = parseCSV(csv);
                    console.log('Parsed questions:', questions);
                    
                    if (questions.length === 0) {
                        showStatus('❌ No valid questions found in CSV! Please check your format.', 'error');
                        return;
                    }

                    // Merge questions into existing data with smart deduplication
                    const mergeStats = mergeQuestionsIntoData(questions);
                    
                    // Update the JSON file (this would typically be a server operation)
                    updateQuestionsFile();
                    
                    // Show detailed merge results
                    let message = '✅ CSV processing completed! ';
                    if (mergeStats.added > 0) message += `Added ${mergeStats.added} new questions. `;
                    if (mergeStats.updated > 0) message += `Updated ${mergeStats.updated} existing questions. `;
                    if (mergeStats.skipped > 0) message += `Skipped ${mergeStats.skipped} duplicate questions. `;
                    message += 'All changes are now available in the game.';
                    
                    showStatus(message, 'success');
                    
                    // Reset form
                    fileInput.value = '';
                    document.getElementById('fileInfo').classList.add('hidden');
                    document.getElementById('progressFill').style.width = '0%';
                    
                    // Refresh question counts
                    updateQuestionCounts();
                    
                } catch (error) {
                    console.error('Error processing CSV:', error);
                    showStatus(`❌ Error processing CSV file: ${error.message}. Please check the format and try again.`, 'error');
                }
            };

            reader.onerror = function(error) {
                console.error('FileReader error:', error);
                showStatus('❌ Error reading CSV file. Please try again.', 'error');
            };

            reader.readAsText(file);
        }

        function parseCSV(csv) {
            console.log('=== CSV PARSING START ===');
            console.log('Raw CSV length:', csv.length);
            console.log('First 500 chars:', csv.substring(0, 500));
            
            const lines = csv.split('\n').filter(line => line.trim());
            console.log('Total lines after filtering:', lines.length);
            
            if (lines.length === 0) {
                throw new Error('CSV file appears to be empty');
            }
            
            const headers = lines[0].split(',').map(h => h.trim());
            console.log('Headers found:', headers);
            
            // Validate headers
            const expectedHeaders = ['module_id', 'module_name', 'difficulty', 'question_text', 'option_a', 'option_b', 'option_c', 'option_d', 'correct_option'];
            console.log('Expected headers:', expectedHeaders);
            
            const headerMatch = expectedHeaders.every(h => headers.includes(h));
            console.log('Headers match:', headerMatch);
            
            if (!headerMatch) {
                console.error('Header mismatch. Found:', headers, 'Expected:', expectedHeaders);
                throw new Error('Invalid CSV headers. Please use the template format.');
            }
            
            const questions = [];
            console.log('Processing', lines.length - 1, 'data lines...');
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i];
                console.log(`Processing line ${i}:`, line.substring(0, 100) + '...');
                
                // Handle quoted CSV fields properly
                const values = parseCSVLine(line);
                console.log(`Parsed values for line ${i}:`, values);
                
                if (values.length >= 9) {
                    const question = {
                        module_id: values[0],
                        module_name: values[1],
                        difficulty: values[2].toLowerCase(),
                        text: values[3],
                        options: [values[4], values[5], values[6], values[7]],
                        correctIndex: ['A', 'B', 'C', 'D'].indexOf(values[8].toUpperCase())
                    };
                    
                    if (question.correctIndex !== -1) {
                        questions.push(question);
                        console.log(`Added question for ${question.module_id} (${question.difficulty})`);
                    } else {
                        console.warn(`Invalid correct_option in line ${i}:`, values[8]);
                    }
                } else {
                    console.warn(`Line ${i} has insufficient columns:`, values.length);
                }
            }
            
            console.log('=== CSV PARSING END ===');
            console.log('Total questions parsed:', questions.length);
            return questions;
        }

        // Helper function to properly parse CSV lines with quoted fields
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim().replace(/^"|"$/g, ''));
                    current = '';
                } else {
                    current += char;
                }
            }
            
            // Add the last field
            result.push(current.trim().replace(/^"|"$/g, ''));
            return result;
        }

        function mergeQuestionsIntoData(newQuestions) {
            console.log('=== SMART MERGE START ===');
            console.log('Processing', newQuestions.length, 'questions for merge');
            console.log('Current data before merge:', allQuestionsData ? Object.keys(allQuestionsData) : 'No data');
            
            let addedCount = 0;
            let updatedCount = 0;
            let skippedCount = 0;
            
            newQuestions.forEach((q, index) => {
                console.log(`Processing question ${index + 1}:`, q.text.substring(0, 50) + '...');
                
                // Initialize module array if it doesn't exist
                if (!allQuestionsData[q.module_id]) {
                    allQuestionsData[q.module_id] = [];
                    console.log('Created new module array:', q.module_id);
                }
                
                // Create question object matching the existing JSON structure
                const questionObj = {
                    question: q.text,
                    options: q.options,
                    correct: q.correctIndex,
                    difficulty: q.difficulty,
                    module: q.module_name
                };
                
                // Check if this question already exists (based on question text)
                const existingQuestionIndex = allQuestionsData[q.module_id].findIndex(
                    existingQ => existingQ.question.trim().toLowerCase() === q.text.trim().toLowerCase()
                );
                
                if (existingQuestionIndex !== -1) {
                    // Question exists - check if it has changed
                    const existingQuestion = allQuestionsData[q.module_id][existingQuestionIndex];
                    
                    // Compare the questions to see if they're different
                    const hasChanged = 
                        JSON.stringify(existingQuestion.options) !== JSON.stringify(questionObj.options) ||
                        existingQuestion.correct !== questionObj.correct ||
                        existingQuestion.difficulty !== questionObj.difficulty ||
                        existingQuestion.module !== questionObj.module;
                    
                    if (hasChanged) {
                        // Update existing question
                        allQuestionsData[q.module_id][existingQuestionIndex] = questionObj;
                        updatedCount++;
                        console.log(`Updated existing question in ${q.module_id}`);
                    } else {
                        // Question is identical, skip
                        skippedCount++;
                        console.log(`Skipped identical question in ${q.module_id}`);
                    }
                } else {
                    // New question - add it
                    allQuestionsData[q.module_id].push(questionObj);
                    addedCount++;
                    console.log(`Added new ${q.difficulty} question to ${q.module_id}`);
                }
            });
            
            console.log('=== SMART MERGE RESULTS ===');
            console.log(`Added: ${addedCount} new questions`);
            console.log(`Updated: ${updatedCount} existing questions`);
            console.log(`Skipped: ${skippedCount} identical questions`);
            
            console.log('Final data after merge - module counts:');
            Object.keys(allQuestionsData).forEach(moduleId => {
                const questions = allQuestionsData[moduleId];
                if (Array.isArray(questions)) {
                    const easyCount = questions.filter(q => q.difficulty === 'easy').length;
                    const hardCount = questions.filter(q => q.difficulty === 'hard').length;
                    console.log(`${moduleId}: ${easyCount} easy, ${hardCount} hard (total: ${questions.length})`);
                }
            });
            console.log('=== SMART MERGE END ===');
            
            // Return merge statistics for user feedback
            return { added: addedCount, updated: updatedCount, skipped: skippedCount };
        }

        function updateQuestionsFile() {
            // Save to localStorage for immediate use
            localStorage.setItem('eduladder_questions', JSON.stringify(allQuestionsData));
            
            // Provide download link for the updated questions.json
            const dataStr = JSON.stringify(allQuestionsData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            // Create download link
            const downloadLink = document.createElement('a');
            downloadLink.href = url;
            downloadLink.download = 'questions.json';
            downloadLink.textContent = 'Download Updated questions.json';
            downloadLink.style.cssText = `
                display: inline-block;
                margin: 10px 0;
                padding: 10px 20px;
                background: #28a745;
                color: white;
                text-decoration: none;
                border-radius: 5px;
                font-weight: bold;
            `;
            
            // Add download message
            const statusContainer = document.getElementById('statusContainer');
            const downloadDiv = document.createElement('div');
            downloadDiv.className = 'status-message status-success';
            downloadDiv.innerHTML = `
                <strong>✅ Questions merged successfully!</strong><br>
                Click the link below to download the updated questions.json file, then replace the file in your questions/ folder.
                <br><br>
            `;
            downloadDiv.appendChild(downloadLink);
            statusContainer.appendChild(downloadDiv);
            
            // Auto-remove after 30 seconds
            setTimeout(() => {
                downloadDiv.remove();
                URL.revokeObjectURL(url);
            }, 30000);
            
            console.log('Questions updated - Download link provided for questions.json');
        }

        function showStatus(message, type) {
            const container = document.getElementById('statusContainer');
            const statusDiv = document.createElement('div');
            statusDiv.className = `status-message status-${type}`;
            statusDiv.innerHTML = message;
            
            container.appendChild(statusDiv);
            
            setTimeout(() => {
                statusDiv.remove();
            }, 5000);
        }

        // Module card selection (for visual feedback)
        document.querySelectorAll('.module-card').forEach(card => {
            card.addEventListener('click', function() {
                document.querySelectorAll('.module-card').forEach(c => c.classList.remove('selected'));
                this.classList.add('selected');
                selectedModule = this.dataset.module;
            });
        });
    </script>
</body>
</html>
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 30px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .admin-header {
            text-align: center;
            margin-bottom: 40px;
            color: #2455db;
        }
        
        .upload-section {
            background: linear-gradient(145deg, #f8f9ff, #e8f0ff);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px dashed #2455db;
        }
        
        .module-selector {
            margin-bottom: 20px;
        }
        
        .module-selector select {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: 2px solid #2455db;
            font-size: 16px;
            background: white;
        }
        
        .difficulty-selector {
            margin-bottom: 20px;
        }
        
        .difficulty-selector input[type="radio"] {
            margin: 0 10px 0 0;
        }
        
        .file-upload {
            margin-bottom: 20px;
        }
        
        .file-upload input[type="file"] {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: 2px solid #2455db;
            background: white;
        }
        
        .csv-template {
            background: #f0f8ff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .preview-section {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #ddd;
            margin-top: 20px;
        }
        
        .question-preview {
            background: #f9f9f9;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #2455db;
        }
        
        .admin-btn {
            background: linear-gradient(45deg, #2455db, #6d94ff);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
        }
        
        .admin-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(36, 85, 219, 0.3);
        }
        
        .admin-btn.danger {
            background: linear-gradient(45deg, #ff4757, #ff6b7a);
        }
        
        .admin-btn.success {
            background: linear-gradient(45deg, #2ed573, #7bed9f);
        }
        
        .admin-btn.warning {
            background: linear-gradient(45deg, #ff9500, #ffb84d);
        }
        
        .status-message {
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .current-questions {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            background: #fafafa;
        }
        
        .navigation {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #eee;
        }
    </style>
</head>
<body>
    <div class="screen" style="background-image: url('images/screen1.png');">
        <div class="admin-container">
            <div class="admin-header">
                <h1>🎯 EduLadder Admin Panel</h1>
                <h2>Question Management System</h2>
                <p>Upload and manage questions for different learning modules</p>
                <div class="status-info">
                    <strong>📝 Important:</strong> CSV uploads ADD questions to the master questions.json file. 
                    Each module can have questions uploaded separately. Questions are merged, not replaced.
                    <br><strong>📁 Use template_questions.csv as your format guide!</strong>
                </div>
            </div>

            <div class="upload-section">
                <h3>📤 Upload Questions via CSV</h3>
                
                <div class="status-info" style="margin-bottom: 20px;">
                    <strong>📋 CSV Format Requirements:</strong><br>
                    • Columns: module_id, module_name, difficulty, question_text, option_a, option_b, option_c, option_d, correct_option<br>
                    • Difficulty: "easy" or "hard" (lowercase)<br>
                    • Correct_option: A, B, C, or D (uppercase)<br>
                    • Module_id must match exactly (case-sensitive)<br>
                    <strong>💡 Tip:</strong> Download the template below to see the exact format!
                </div>
                
                <div class="module-selector">
                    <label for="moduleSelect"><strong>Select Target Module (for verification):</strong></label>
                    <select id="moduleSelect">
                        <option value="">-- Choose Module --</option>
                        <option value="tlprocess">Teaching Learning Process</option>
                        <option value="learningtheories">Learning Theories</option>
                        <option value="fourways">4 Ways of Learning</option>
                        <option value="andragogy">Andragogy</option>
                        <option value="sat">Systematic Approach to Training (SAT)</option>
                        <option value="btm">Basic Teaching Model</option>
                        <option value="dol">Domains of Learning</option>
                        <option value="objectives">Writing Objectives</option>
                    </select>
                </div>

                <div class="file-upload">
                    <label for="csvFile"><strong>Choose CSV File:</strong></label>
                    <input type="file" id="csvFile" accept=".csv" />
                </div>

                <button class="admin-btn" onclick="uploadCSV()">📤 Upload & Merge Questions</button>
                <button class="admin-btn success" onclick="downloadTemplate()">📋 Download CSV Template</button>
            </div>

            <div class="csv-template">
                <h4>📋 CSV Format Requirements:</h4>
                <p><strong>Required columns (in exact order):</strong></p>
                <ol>
                    <li><strong>question_text</strong> - The question text</li>
                    <li><strong>option1</strong> - First answer option</li>
                    <li><strong>option2</strong> - Second answer option</li>
                    <li><strong>option3</strong> - Third answer option</li>
                    <li><strong>option4</strong> - Fourth answer option</li>
                    <li><strong>correct_answer</strong> - Number (1-4) indicating correct option</li>
                </ol>
                <p><strong>Example:</strong></p>
                <code>
                    "What is 2+2?","2","3","4","5","3"
                </code>
            </div>

            <div id="statusMessages"></div>

            <div class="preview-section">
                <h3>👀 Question Preview</h3>
                <div id="questionPreview">
                    <p>Upload a CSV file to preview questions...</p>
                </div>
            </div>

            <div class="preview-section">
                <h3>📚 Current Questions in Database</h3>
                <div class="module-selector">
                    <select id="viewModuleSelect" onchange="viewCurrentQuestions()">
                        <option value="">-- Select Module to View --</option>
                        <option value="tlprocess">Teaching Learning Process</option>
                        <option value="learningtheories">Learning Theories</option>
                        <option value="fourways">4 Ways of Learning</option>
                        <option value="andragogy">Andragogy</option>
                        <option value="sat">Systematic Approach to Training (SAT)</option>
                        <option value="btm">Basic Teaching Model</option>
                        <option value="dol">Domains of Learning</option>
                        <option value="objectives">Writing Objectives</option>
                    </select>
                </div>
                <div id="currentQuestions" class="current-questions">
                    <p>Select a module to view current questions...</p>
                </div>
                <button class="admin-btn danger" onclick="clearModuleQuestions()">🗑️ Clear All Questions for Selected Module</button>
            </div>

            <div class="navigation">
                <button class="admin-btn success" onclick="goToGame()">🎮 Back to Game</button>
                <button class="admin-btn" onclick="exportAllQuestions()">💾 Export All Questions</button>
                <button class="admin-btn warning" onclick="removeDuplicateQuestions()">🧹 Remove Duplicates</button>
            </div>
        </div>
    </div>

    <script>
        let previewQuestions = [];

        // Load existing questions on page load
        window.addEventListener('load', loadExistingQuestions);

        async function loadExistingQuestions() {
            // This function is now handled by the main load event listener above
            // which calls loadQuestionsData() and updateQuestionCounts()
        }

        function downloadTemplate() {
            // Create the template content with new module IDs and names
            const csvContent = `module_id,module_name,difficulty,question_text,option_a,option_b,option_c,option_d,correct_option
mod1,Domains of Learning,easy,Which of the following is NOT one of the three primary domains of learning?,Cognitive,Affective,Psychomotor,Social,D
mod1,Domains of Learning,hard,Which action verb is most suitable for the Responding level in the affective domain?,Assists,Organizes,Evaluates,Generates,A
mod2,TOS, Master Syllabus & Evaluation,easy,What does TOS stand for in educational planning?,Table of Specifications,Test of Skills,Training Outcome Standards,Technical Objective Setting,A
mod2,TOS, Master Syllabus & Evaluation,hard,Which evaluation method provides immediate feedback during the learning process?,Summative evaluation,Formative evaluation,Diagnostic evaluation,Comparative evaluation,B
mod3,TL process, Andragogy, SAT, BTM & Ways of Learning,easy,What does the acronym SAT stand for?,Standard Assessment of Training,Systematic Approach to Teaching,Systematic Approach to Training,Strategic Analysis of Tasks,C
mod3,TL process, Andragogy, SAT, BTM & Ways of Learning,hard,Who designed the Basic Teaching Model (BTM)?,B.F. Skinner,Jean Piaget,Robert Glaser,Ivan Pavlov,C
mod4,Objectives, Maxims & Questioning Technique,easy,A well-written learning objective should be:,Vague and general,Specific and measurable,Impossible to achieve,Only for teachers,B
mod4,Objectives, Maxims & Questioning Technique,hard,What is a maxim in educational context?,A type of assessment,A fundamental principle or rule,A learning objective,A teaching method,B
mod5,Lesson, Lecture, Demonstration, Group Discussion, Coaching, CBT, Media in Training,easy,CBT stands for:,Computer-Based Training,Cognitive Behavioral Therapy,Competency-Based Testing,Classroom-Based Teaching,A
mod5,Lesson, Lecture, Demonstration, Group Discussion, Coaching, CBT, Media in Training,hard,Which method is most effective for developing problem-solving skills?,Lecture,Demonstration,Group Discussion,Reading,C
mod6,Instructor Like Qualities, Video in Training, Feedback,easy,Effective feedback should be:,General and vague,Specific and timely,Only positive,Given once at the end,B
mod6,Instructor Like Qualities, Video in Training, Feedback,hard,Which instructor quality helps build rapport with learners?,Strictness,Empathy,Perfectionism,Aloofness,B
mod7,TDEC, Item Analysis, Result Analysis,easy,TDEC stands for:,Training Design and Evaluation Committee,Technical Development and Education Center,Test Development and Evaluation Cycle,Training Documentation and Evaluation Criteria,A
mod7,TDEC, Item Analysis, Result Analysis,hard,Which statistical measure is used to determine item difficulty?,Mean score,Percentage of correct responses,Standard deviation,Correlation coefficient,B
mod8,Training Directives,easy,Training directives are issued by:,Individual instructors,Training institutions,Higher military/organizational authorities,Student committees,C
mod8,Training Directives,hard,Which level of authority typically issues training directives for military institutions?,Company level,Platoon level,Command/Headquarters level,Individual level,C
mod9,Motivation, Communication, Code of Ethics,easy,Effective communication in training requires:,Speaking loudly,Using technical jargon,Clear, simple language,Avoiding eye contact,C
mod9,Motivation, Communication, Code of Ethics,hard,Which communication barrier is most common in training environments?,Physical distance,Language and technical complexity,Time constraints,Equipment failure,B`;
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'template_questions.csv';
            a.click();
            window.URL.revokeObjectURL(url);
            showStatus('✅ CSV template downloaded successfully! Use this exact format for uploading questions.', 'success');
        }



        function displayPreview(questions) {
            const preview = document.getElementById('questionPreview');
            let html = `<h4>Preview of ${questions.length} questions:</h4>`;

            questions.slice(0, 5).forEach((q, index) => {
                html += `
                    <div class="question-preview">
                        <strong>Q${index + 1}:</strong> ${q.text}<br>
                        <strong>Options:</strong><br>
                        ${q.options.map((opt, i) => 
                            `${i + 1}. ${opt} ${i === q.correctIndex ? '✅' : ''}`
                        ).join('<br>')}
                    </div>
                `;
            });

            if (questions.length > 5) {
                html += `<p><em>... and ${questions.length - 5} more questions</em></p>`;
            }

            html += `<button class="admin-btn success" onclick="saveQuestions()">💾 Save Questions to Database</button>`;

            preview.innerHTML = html;
        }

        function saveQuestions() {
            // Convert to JSON and trigger download
            const jsonData = JSON.stringify(allQuestionsData, null, 2);
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'questions.json';
            a.click();
            window.URL.revokeObjectURL(url);

            showStatus('Questions saved! Please replace the questions.json file in your project.', 'success');
        }

        function viewCurrentQuestions() {
            const moduleSelect = document.getElementById('viewModuleSelect');
            const container = document.getElementById('currentQuestions');

            if (!moduleSelect.value) {
                container.innerHTML = '<p>Select a module to view current questions...</p>';
                return;
            }

            const moduleKey = moduleSelect.value;
            const moduleData = allQuestionsData[moduleKey];

            if (!moduleData) {
                container.innerHTML = '<p>No questions found for this module.</p>';
                return;
            }

            let html = `<h4>${moduleData.name}</h4>`;
            
            html += `<h5>Easy Questions (${moduleData.easy?.length || 0}):</h5>`;
            (moduleData.easy || []).forEach((q, index) => {
                html += `
                    <div class="question-preview">
                        <strong>Easy Q${index + 1}:</strong> ${q.text}<br>
                        <strong>Correct Answer:</strong> ${q.options[q.correctIndex]}
                    </div>
                `;
            });

            html += `<h5>Hard Questions (${moduleData.hard?.length || 0}):</h5>`;
            (moduleData.hard || []).forEach((q, index) => {
                html += `
                    <div class="question-preview">
                        <strong>Hard Q${index + 1}:</strong> ${q.text}<br>
                        <strong>Correct Answer:</strong> ${q.options[q.correctIndex]}
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function clearModuleQuestions() {
            const moduleSelect = document.getElementById('viewModuleSelect');
            
            if (!moduleSelect.value) {
                showStatus('Please select a module first!', 'error');
                return;
            }

            if (confirm(`Are you sure you want to clear all questions for ${moduleSelect.options[moduleSelect.selectedIndex].text}?`)) {
                const moduleKey = moduleSelect.value;
                if (allQuestionsData[moduleKey]) {
                    allQuestionsData[moduleKey].easy = [];
                    allQuestionsData[moduleKey].hard = [];
                    viewCurrentQuestions();
                    showStatus('Questions cleared for selected module!', 'success');
                }
            }
        }

        function exportAllQuestions() {
            const jsonData = JSON.stringify(allQuestionsData, null, 2);
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `questions_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            showStatus('All questions exported successfully!', 'success');
        }

        function removeDuplicateQuestions() {
            if (!confirm('⚠️ This will remove duplicate questions from the database based on question text. This action cannot be undone. Are you sure you want to continue?')) {
                return;
            }
            
            console.log('=== DUPLICATE REMOVAL START ===');
            let totalRemoved = 0;
            
            Object.keys(allQuestionsData).forEach(moduleId => {
                if (!Array.isArray(allQuestionsData[moduleId])) {
                    return;
                }
                
                const originalCount = allQuestionsData[moduleId].length;
                const seen = new Set();
                const uniqueQuestions = [];
                
                allQuestionsData[moduleId].forEach(question => {
                    const questionKey = question.question.trim().toLowerCase();
                    
                    if (!seen.has(questionKey)) {
                        seen.add(questionKey);
                        uniqueQuestions.push(question);
                    }
                });
                
                const removedCount = originalCount - uniqueQuestions.length;
                allQuestionsData[moduleId] = uniqueQuestions;
                
                if (removedCount > 0) {
                    console.log(`${moduleId}: Removed ${removedCount} duplicates (${originalCount} → ${uniqueQuestions.length})`);
                    totalRemoved += removedCount;
                }
            });
            
            console.log(`=== DUPLICATE REMOVAL END: ${totalRemoved} total duplicates removed ===`);
            
            if (totalRemoved > 0) {
                showStatus(`✅ Successfully removed ${totalRemoved} duplicate questions from the database!`, 'success');
                updateQuestionCounts();
                
                // Auto-save the cleaned data
                updateQuestionsFile();
            } else {
                showStatus('ℹ️ No duplicate questions found in the database.', 'info');
            }
        }

        function goToGame() {
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
